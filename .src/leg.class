' Gambas class file

Export

Public ShoulderAngle As Float = 0.0               ' current angle of the sholder we will need to calculate vertical distance
Public ShoulderOffset As Integer = 0.0            ' this is the actual servo value +- 0-1000

Public legUpperLen As Float = 73.00               ' length in mm
Public legLowerLen As Float = 57.15               ' length in mm

Public LegUpperOffset As Integer = 0              ' offet from zero of these angels
Public LegLowerOffset As Integer = 0              ' offset from zero for these angles

Public DistanceToGround As Float = 80               ' mm
Public MaxDistanceSupported As Float = LegUpperLen + LegLowerLen 'this is max length
Public MinDistanceSupported As Float = 71  
Public MaxAngleAtDistanceToGround As Float = 0.0
  '
Public UpperAngle As Float = 00.00                ' angle of leg at top joint
Public LowerAngle As Float = 00.00                ' we need to calculate this to keep lower foot at required distace for floor
Public DistanceFromKneeToGround As Float = 00.00  ' calc this too

Public ServoUpper As Servo
Public ServoLower As Servo
Public ServoShoulder As Servo
Public ServoBroadcast As Servo



Public Sub CalcLegPos()
  ' using SSS formula for side as angles
  Dim KneeAngle As Float 
  Dim AnkleAngle As Float
  
  Print "Requested Distance to Ground :" & DistanceToGround & "\n"
  
  If DistanceToGround > MaxDistanceSupported Then DistanceToGround = MaxDistanceSupported ' limit stupid requests
  If DistanceToGround < MinDistanceSupported Then DistanceToGround = MinDistanceSupported ' Min and Max
  
   Print "Actual Distance to Ground Adjusted:" & DistanceToGround & "\n"
  
  KneeAngle = Deg(ACos((legLowerLen ^ 2 + legUpperLen ^ 2 - DistanceToGround ^ 2) / (2 * LegLowerLen * LegUpperLen)))
  Print "The New Knee Angle is :" & KneeAngle & "\n"
  UpperAngle = Deg(ACos((DistanceToGround ^ 2 + LegUpperLen ^ 2 - LegLowerLen ^ 2) / (2 * LegUpperLen * DistanceToGround)))
  Print "The New Upper angle is :" & UpperAngle & " \n "
  AnkleAngle = Deg(ACos((DistanceToGround ^ 2 + LegLowerLen ^ 2 - LegUpperLen ^ 2) / (2 * DistanceToGround * LegLowerLen)))
  Print "The New Ankle angle is :" & AnkleAngle & "\n"
  LowerAngle = 180 - KneeAngle
  Print "The New Knee Joint angle :" & LowerAngle & "\n"
  
  
End

Public Sub MoveToPosition()
  
  CalcLegPos()
  Print "Move to distance Upr, lowr,shoulder:", ServoUpper.ZeroPointOffset + LegUpperOffset + CInt(UpperAngle / 0.24), ServoLower.ZeroPointOffset + LegLowerOffset - CInt(LowerAngle / 0.24), ServoShoulder.ZeroPointOffset + ShoulderOffset - CInt(ShoulderAngle / 0.24), "\n"
  
  ServoUpper.SERVO_MOVE_TIME_WAIT_WRITE_int(ServoUpper.ZeroPointOffset + LegUpperOffset + CInt(UpperAngle / 0.24), 300)
  ServoLower.SERVO_MOVE_TIME_WAIT_WRITE_int(ServoLower.ZeroPointOffset + LegLowerOffset + CInt(LowerAngle / 0.24), 300)
  ServoShoulder.SERVO_MOVE_TIME_WAIT_WRITE_int(ServoShoulder.ZeroPointOffset + ShoulderOffset - CInt(ShoulderAngle / 0.24), 300)
  ServoBroadcast.SERVO_MOVE_START() 
  
End

Public Sub MoveToZeroPosition()

  Print "Move Zero Point Uppr,Lower,Shoulder :", ServoUpper.ZeroPointOffset + LegUpperOffset, ServoLower.ZeroPointOffset + LegLowerOffset, ServoShoulder.ZeroPointOffset + ShoulderOffset, "\n"
  ServoUpper.SERVO_MOVE_TIME_WAIT_WRITE_int(ServoUpper.ZeroPointOffset + LegUpperOffset, 300)
  ServoLower.SERVO_MOVE_TIME_WAIT_WRITE_int(ServoLower.ZeroPointOffset + LegLowerOffset, 300)
  ServoShoulder.SERVO_MOVE_TIME_WAIT_WRITE_int(ServoShoulder.ZeroPointOffset + ShoulderOffset, 300)
  LowerAngle = 0
  UpperAngle = 0
  ShoulderAngle = 0
  DistanceToGround = MaxDistanceSupported
  ServoBroadcast.SERVO_MOVE_START() 
  
End

Public Sub MoveAdjust()
  
  Print "Move to distance Upr, lowr,shoulder:", ServoUpper.ZeroPointOffset + LegUpperOffset + CInt(UpperAngle / 0.24), ServoLower.ZeroPointOffset + LegLowerOffset - CInt(LowerAngle / 0.24), ServoShoulder.ZeroPointOffset + ShoulderOffset - CInt(ShoulderAngle / 0.24), "\n"
  
  ServoUpper.SERVO_MOVE_TIME_WAIT_WRITE_int(ServoUpper.ZeroPointOffset + LegUpperOffset + CInt(UpperAngle / 0.24), 300)
  ServoLower.SERVO_MOVE_TIME_WAIT_WRITE_int(ServoLower.ZeroPointOffset + LegLowerOffset - CInt(LowerAngle / 0.24), 300)
  ServoShoulder.SERVO_MOVE_TIME_WAIT_WRITE_int(ServoShoulder.ZeroPointOffset + ShoulderOffset - CInt(ShoulderAngle / 0.24), 300)
  ServoBroadcast.SERVO_MOVE_START() 
  
End








